<!DOCTYPE html>
<html lang="en">
<head>
    <title>MicrogridUP &raquo; Home</title>
    <style>
        /* SEMANTIC ELEMENTS */
        :root {
            /* Heading div was moved into top nav */
            /*--headingDivHeight: 3rem;*/
            --mobileToDesktopBreakpointWidth: 977px;
            --sideNavTransitionTime: 0.3s;
            --sideNavWidth: 272px;
            --topNavHeight: 64px;
        }
        @media screen and (min-width: 977px) {
            article {
                margin: 0;
                transition: margin-left var(--sideNavTransitionTime);
            }
            article.compressed {
                margin-left: var(--sideNavWidth);
                transition: margin-left var(--sideNavTransitionTime);
            }
        }
        body {
            margin: 0;
            background: white;
        }
        body.loading {
            overflow-y: hidden;
        }
        header {
            height: var(--topNavHeight);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        header span {
            color: white;
        }
        iframe {
            border: 0;
            width: 100%;
            height: calc(99.5vh - var(--topNavHeight));
            /*height: calc(99vh - var(--topNavHeight) - var(--headingDivHeight));*/
        }
        main {
            height: calc(100% - var(--topNavHeight));
            padding: var(--topNavHeight) 0px 0px 0px;
        }
        main.loading {
            padding: initial;
        }
        /* No longer used
        div.div--spanDisplay {
            align-items: center;
            display: flex;
            height: var(--headingDivHeight);
        } */
        section.hidden {
            display: none;
        }
        section.loading {
            visibility: hidden;
        }
        span.span--sectionTitle {
            font-family: sans-serif;
            font-size: 2rem;
            padding-left: 1rem;
        }
        div > span.span--sectionTitle:nth-child(2) {
            padding-left: .5rem;
        }
        /* TOP NAV */
        nav.js-nav--topNav {
            background: black;
            display: flex;
            height: 100%;
        }
        /* TOP NAV ANCHORS */
        nav.js-nav--topNav a {
            text-decoration: none;
        }
        /* TOP NAV BUTTONS */
        nav.js-nav--topNav button {
            border: 0;
            background-color: transparent;
            cursor: pointer;
            padding: 14px;
            width: var(--topNavHeight);
        }
        nav.js-nav--topNav button:hover {
            background-color: gray;
            transition: background-color 0.2s ease-out;
        }
        /* TOP NAV SPANS */
        nav.js-nav--topNav div {
            align-items: center;
            display: flex;
        }
        /* TOP NAV SVGS */
        nav.js-nav--topNav svg {
            fill: white;
        }
        nav.js-nav--sideNav {
            /*background-clip: content-box;*/
            background-color: white;
            box-shadow: inset -1px 0px darkgray;
            font-family: sans-serif;
            height: 100%;
            overflow-y: auto;
            position: fixed;
            transform: translate(calc(var(--sideNavWidth) * -1), 0px);
            transition: transform var(--sideNavTransitionTime);
            width: var(--sideNavWidth);
            z-index: 1;
        }
        nav.js-nav--sideNav.open {
            transform: translate(0px, 0px);
        }
        /* SIDE NAV BUTTONS */
        nav.js-nav--sideNav button {
            /*background-clip: content-box;*/
            align-items: center;
            background-color: white;
            box-shadow: inset -1px 0px darkgray;
            border: 0;
            cursor: pointer;
            display: flex;
            height: 6em;
            padding: 10px 0 10px 10px;
            width: 100%;
        }
        nav.js-nav--sideNav button:hover {
            background-color: lightgray;
        }
        /* Safari workaround for missing :focus implementation */
        nav.js-nav--sideNav button.focused {
            /*background-clip: content-box;*/
            box-shadow: inset 0 0 0 1px darkgray;
        }
        nav.js-nav--sideNav button.focused > span {
            font-weight: bold;
        }
        /* SIDE NAV COVER */
        div.js-div--sideNavCover {
            display: none;
        }
        div.js-div--sideNavCover.loading {
            align-items: center;
            background-color: rgba(189, 189, 189, 0.6);
            display: flex;
            height: 100%;
            justify-content: space-around; 
            position: fixed;
            width: 100%;
        }
        @media screen and (max-width: 976px) {
            div.js-div--sideNavCover.open {
                background-color: rgba(189, 189, 189, 0.6);
                display: initial;
                height: 100%;
                position: fixed;
                width: 100%;
            }
        }
        /* SIDE NAV BUTTON DIVS */
        div.js-div--dropdownContainer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s;
        }
        div.js-div--dropdownContainer.expanded {
            max-height: 500px;
            /* TODO: fix box shadow with scroll bar */
            overflow: auto;
        }
        /* SIDE NAV BUTTON SPANS */
        nav.js-nav--sideNav * span {
            color: black;
            margin: auto 0 auto 1rem;
            font-size: 1.6rem;
        }
        div.js-div--dropdownContainer > * > span {
            font-size: 1.35rem;
            margin: auto 0 auto 2rem;
        }
        div.js-div--dropdownContainer > div.js-div--dropdownContainer > * > span {
            font-size: 1rem;
            margin: auto 0 auto 3rem;
        }
        /* SIDE NAV SVGS */
        nav.js-nav--sideNav svg {
            transform: rotate(0deg);
            transition: transform 0.25s;
            transform-box: fill-box;
            transform-origin: center;
            width: 20%;
        }
        nav.js-nav--sideNav svg.rotated {
            transform: rotate(90deg);
        }
        /* HOMEPAGE */
        div.box {
            width:400px;
            height:300px;
            background:white;
            border:1px black solid;
            display:inline-block;
            text-align:left;
            margin:5px;
            padding:5px;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0.15rem 0.5rem 0 rgba(58, 59, 69, 0.15) !important;
            position: relative;
        }
        div.box a {
            color: mediumseagreen;
            font-family: sans-serif;
            text-decoration: none;
        }
        div.clickable-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 4px;
        }
        div.clickable-container .project-name {
            font-size: 32px;
            margin-left: 52px;
            margin-top: 7px;
            display: inline-block;
            max-width: calc(100% - 60px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        div.clickable-container svg {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            fill: mediumseagreen;
        }
        div.box p {
            font-family: sans-serif;
            text-decoration: none;
        }
        div.box p.description {
            color: seagreen;
            font-size: 65%;
        }
        div.box p.timestamp {
            color: mediumseagreen;
            font-size: 60%;
        }
        div.box p.status {
            color: rgb(66, 66, 66);
            font-size: 60%;
        }
        div.box a:visited {
            color: seagreen;
            text-decoration: none;
        }
        div.clickable-container a:visited svg {
            fill: seagreen;
        }
        #container {
            display:inline;
            width:auto;
            float:left;
            text-align:center;
            font-size:25px;
        }
        #newModelBox a:hover {
            color:mediumseagreen;
        }
        #sorting-control {
            text-align: right;
            margin-right: 80px;
            font-size: 65%;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <header>
        <nav class="js-nav--topNav">
            <div>
                <a href="/">
                    <span class="span--sectionTitle">MicrogridUp &raquo; Home</span>
                </a>
            </div>
        </nav>
    </header>
    <main>
        <div id='container' style='margin-top:10px'>
            <div id="sorting-control">
                <label for="sort-by">Sort by:</label>
                <select id="sort-by">
                    <option value="" disabled selected>Select method</option>
                    <option value="name">Project Name</option>
                    <option value="date">Creation Date</option>
                </select>
            </div>
            <div id="box-container">
            {% for project in projects %}
                <div class='box'>
                    <div class="clickable-container">
                        <a class="project-name" href='load/{{project}}'>
                            <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="44px" height="44px"><path d="M 8.5 8 C 6.0324991 8 4 10.032499 4 12.5 L 4 35.5 C 4 37.967501 6.0324991 40 8.5 40 L 39.5 40 C 41.967501 40 44 37.967501 44 35.5 L 44 17.5 C 44 15.032499 41.967501 13 39.5 13 L 24.042969 13 L 19.572266 9.2753906 C 18.584055 8.4521105 17.339162 8 16.052734 8 L 8.5 8 z M 8.5 11 L 16.052734 11 C 16.638307 11 17.202555 11.205358 17.652344 11.580078 L 21.15625 14.5 L 17.652344 17.419922 C 17.202555 17.794642 16.638307 18 16.052734 18 L 7 18 L 7 12.5 C 7 11.653501 7.6535009 11 8.5 11 z M 24.042969 16 L 39.5 16 C 40.346499 16 41 16.653501 41 17.5 L 41 35.5 C 41 36.346499 40.346499 37 39.5 37 L 8.5 37 C 7.6535009 37 7 36.346499 7 35.5 L 7 21 L 16.052734 21 C 17.339162 21 18.584055 20.547889 19.572266 19.724609 L 24.042969 16 z"/></svg>
                            {{project}}
                        </a>
                    </div>
                    <a href='javascript:duplicate("{{project}}")'>[dup]</a>
                    <a href='edit/{{project}}'>[edit]</a>
                    <a href='delete/{{project}}' onclick='return confirmDelete(event)'>[del]</a>
                    {% if project in project_timestamps %}
                    <p class="timestamp">Last updated: {{ project_timestamps[project].strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    {% endif %}
                    {% if project in project_descriptions %}
                    <p class="description">Description: {{ project_descriptions[project] }}</p>
                    {% endif %}
                    <p class="status">Checking status...</p>
                </div>
                {% endfor %}
            </div>            
            <div class="box" id="newModelBox" style="border:1px black dashed">
                <a href='/new' style="font-size:50px">+</a>
            </div>
        </div>
    </main>
    <script>
        // Sorts box elements by project name.
        function sortByProjectName() {
            const boxContainer = document.getElementById('box-container');
            const boxes = Array.from(boxContainer.getElementsByClassName('box'));
            boxes.sort((a, b) => {
                const nameA = a.querySelector('.project-name').textContent.toLowerCase();
                const nameB = b.querySelector('.project-name').textContent.toLowerCase();
                return nameA.localeCompare(nameB);
            });
            boxes.forEach((box) => boxContainer.appendChild(box));
        }

        // Sorts 'box' elements by creation date.
        function sortByCreationDate() {
            const boxContainer = document.getElementById('box-container');
            const boxes = Array.from(boxContainer.getElementsByClassName('box'));
            boxes.sort((a, b) => {
                const timestampA = a.querySelector('.timestamp').textContent;
                const timestampB = b.querySelector('.timestamp').textContent;
                const dateA = new Date(timestampA);
                const dateB = new Date(timestampB);
                return dateB - dateA;
            });
            boxes.forEach((box) => boxContainer.appendChild(box));
        }

        // Event listener to handle sorting when the selection changes.
        document.getElementById('sort-by').addEventListener('change', function () {
            const sortBy = this.value;
            if (sortBy === 'name') {
                sortByProjectName();
            } else if (sortBy === 'date') {
                sortByCreationDate();
            }
        });

        function duplicate(project) {
            var new_name = prompt('Name for the duplicate?', '');
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText);
                    location.reload();
                };
            };
            xhr.open('POST', '/duplicate', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            var contents = JSON.stringify({
                'project':project,
                'new_name':new_name
            });
            xhr.send(contents);
            alert(contents);
        }

        function confirmDelete(event) {
            var confirmed = confirm("Are you sure you want to delete?");
            if (!confirmed) {
                event.preventDefault();
            }
        }

        function checkStatus(projects) {
            for (let i = 0; i < projects.length; i++) {
                const model_name = projects[i];
                const projectLink = document.querySelector(`.clickable-container a[href='load/${model_name}']`);
                const statusElement = projectLink ? projectLink.closest('.box').querySelector('.status') : null;
                const checkStatusUrl = `/check_status/${model_name}`;
                const xhr = new XMLHttpRequest();
                xhr.open('GET', checkStatusUrl, true);
                // Event listener to process the response.
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.status === 'complete') {
                            statusElement.textContent = "Status: Finished";
                        } else if (data.status === 'crashed') {
                            statusElement.textContent = "Status: Crashed";
                        } else {
                            statusElement.textContent = "Status: In Progress";
                        }
                    } else {
                        console.log('Error:', xhr.status);
                    }
                };
                // Handle network errors.
                xhr.onerror = function () {
                    console.log('Network Error.');
                };
                // Send the request.
                xhr.send();
            }
        }
        window.onload = function () {
            const projects_json = '{{ projects | tojson }}';
            const projects = JSON.parse(projects_json);
            setInterval(checkStatus(projects), 8000); // Check status each 8 seconds.
        }
    </script>
</body>
</html>