<!DOCTYPE html>
<html>
<head>
	<title>MicrogridUP &raquo; New</title>
    <link rel="stylesheet" href="/data/static/circuitBuilder/modals/modal.css">
    <script type="module" src="/data/static/circuitBuilder/modals/circuitBuilder.js"></script>
    <script src="/data/static/circuitBuilder/graphology-library.min.js"></script>
    <script src="/data/static/circuitBuilder/graphology.min.js"></script>
    <script src="/data/static/circuitBuilder/papaparse.min.js"></script>
	<script src="https://kit.fontawesome.com/92028f16c4.js" crossorigin="anonymous"></script>
	<style type="text/css">
        :root {
            --topNavHeight: 64px;
        }
		body {
			margin-top: 0px;
			margin-left:0;
			padding:0;
			border:0;
			font-family:sans-serif;
		}
		h3, h5, p {
			margin-bottom:7px;
			margin-left: 5px;
		}
		.chunk, .desc {
			display: inline-block;
			background-color: lightgray;
			padding: 6px;
			border-radius: 4px;
			margin: 4px 2px 4px 2px;
		}
		#stepThree {
			margin-left: 5px;
		}
		form {
			/* width: 100%; */
			margin-left: 5px;
		}
		button, input[type='submit'], label.fileButton {
			width:auto;
			padding: 9px;
			margin-left: 5px;
			margin-right:5px;
			margin-top: 5px;
			font-size:small;
			background:seagreen;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
			border: none;
			color: white;
			cursor:pointer;
		}
		button:hover, input[type='submit']:hover, label.fileButton:hover {
			background: mediumseagreen;
		}
		/* Style for the disabled button state */
		button[disabled], input[type='submit'][disabled], label.fileButton[disabled] {
			background: rgba(46, 139, 86, 0.561);
			color: rgba(255, 255, 255, 0.725); 
			cursor: default;
		}
		textarea {
			font-size: 12pt;
			margin-left: 5px;
			display: inline-block;
		}
		.advanced {
			display: inline-block;
			max-width: 50%;
			min-width: 500px;
		}
		.step {
		  max-width: 1000;
		  display: block;
		  margin: 0 auto;
		}
		.tooltip {
			border-bottom: 1px dotted #000000; 
			color: #000000;
			outline: none;
			cursor: help; 
			text-decoration: none;
			position: relative;
		}
		.tooltip span {
			margin-left: -999em;
			position: absolute;
			display: inline-block;
		}
		.tooltip:hover span {
			border-radius: 5px 5px; 
			-moz-border-radius: 5px; 
			-webkit-border-radius: 5px; 
			box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1); 
			-webkit-box-shadow: 5px 5px rgba(0, 0, 0, 0.1); 
			-moz-box-shadow: 5px 5px rgba(0, 0, 0, 0.1);
			font-family: Calibri, Tahoma, Geneva, sans-serif;
			position: absolute; 
			left: 0.5em; 
			top: 1.5em; 
			z-index: 99;
			margin-left: 0; 
			width: 200px;
		}
		.classic {
			background: #A9A9A9; 
			color: white; 
			padding: 5px 5px;
		}
		a {text-decoration: none; color: black;}
		a:hover {text-decoration: underline;}
		#previewImage, #oldPartitionPreview {
			max-width: 700px;
			padding: 10px;
		}
		.wizard-dropbutton {
		  color: white;
		  border: none;
		}
		.wizard-dropdown {
		  position: relative;
		  display: inline-block;
		}
		.wizard-dropdown-content {
		  display: none;
		  position: absolute;
		  background-color: #f1f1f1;
		  min-width: 160px;
		  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
		  z-index: 1;
		}
		.wizard-dropdown-content div {
		  color: black;
		  padding: 12px 16px;
		  text-decoration: none;
		  display: block;
		}
		.wizard-dropdown-content div:hover {background-color: #ddd; cursor: pointer;}
		.wizard-dropdown:hover .wizard-dropdown-content {display: block;}
		.wizard-dropdown:hover .wizard-dropbutton {background-color: mediumseagreen;}
		.substation {
		    padding-left: 0px;
		    list-style: none;
		}
		#elements .feeder {
			padding-left: 40px;
			list-style: none;
		}
		#elements .load, .solar, .battery, .wind, .fossil {
			padding-left: 80px;
			list-style: none;
		}
		#elements li i {
			cursor:pointer;
		}
		#loading-background {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 9998;
			background-color: rgba(0, 0, 0, 0.5);
			display: none;
		}
		#loading-indicator {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			z-index: 9999;
			background-color: white;
			padding: 20px;
			padding-left: 1rem;
			border-radius: 10px;
			text-align: center;
			display: none;
		}
		#loading-indicator span {
			display: block;
			font-size: 2rem;
			animation: fadeInOut 2s linear infinite forwards;
		}
		@keyframes fadeInOut {
			0%,100% { opacity: 1; }
			50% { opacity: 0; }
		}
        header {
            height: var(--topNavHeight);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1;
        }
        header span {
            color: white;
        }
        main {
            height: calc(100% - var(--topNavHeight));
            {% if not iframe_mode %}
            padding: var(--topNavHeight) 0px 0px 0px;
            {% endif %}
        }
        span.span--sectionTitle {
            font-family: sans-serif;
            font-size: 2rem;
            padding-left: 1rem;
        }
        div > span.span--sectionTitle:nth-child(2) {
            padding-left: .5rem;
        }
        /* TOP NAV */
        nav.js-nav--topNav {
            background: black;
            display: flex;
            height: 100%;
        }
        /* TOP NAV ANCHORS */
        nav.js-nav--topNav a {
            text-decoration: none;
        }
        /* TOP NAV BUTTONS */
        nav.js-nav--topNav button {
            border: 0;
            background-color: transparent;
            cursor: pointer;
            padding: 14px;
            width: var(--topNavHeight);
        }
        nav.js-nav--topNav button:hover {
            background-color: gray;
            transition: background-color 0.2s ease-out;
        }
        /* TOP NAV SPANS */
        nav.js-nav--topNav div {
            align-items: center;
            display: flex;
        }
        /* TOP NAV SVGS */
        nav.js-nav--topNav svg {
            fill: white;
        }
	</style>
</head>
<body>
    {% if not iframe_mode %}
    <header>
        <nav class="js-nav--topNav">
            <div>
                <a href="/">
                    <span class="span--sectionTitle">MicrogridUp &raquo; {% if editing %}Edit Model{% else %}New{% endif %}</span>
                </a>
            </div>
        </nav>
    </header>
    {% endif %}
    <main>
        <!--<div style="height:40px; width:100%; background:black; line-height:40px; padding-left:10px;">
            <p style="color:white; margin:0px"><a style="color:white; text-decoration:none" href="/"><b>MicrogridUP</b></a> &raquo; New</p>
        </div>-->
        <div id='introInfo' class='step'>
            <h3>Step 1: Input model information</h3>
            <form id="modelInfoForm" enctype="multipart/form-data">
                <h5>Site and Energy Provider</h5>
                <div class="chunk">
                    <label class="tooltip" for="MODEL_DIR">Model Name<span class="classic">Model names must be entirely lowercase.</span></label>
                    <input type="text" name="MODEL_DIR" value="{{in_data.MODEL_DIR}}" pattern="[a-z0-9_\-]+" required/>
                </div>
                <div class="chunk">
                    <label class="tooltip" for="latitude">Latitude<span class="classic">Specify the latitude of the load/grid as a decimal.</span></label>
                    <input type="text" name="latitude" pattern="-?\d+\.?\d*" value="{{ in_data.REOPT_INPUTS.get('latitude','39.7817') }}"/>
                </div>
                <div class="chunk">
                    <label class="tooltip" for="longitude">Longitude<span class="classic">Specify the longitude of the load/grid as a decimal.</span></label>
                    <input type="text" name="longitude" pattern="-?\d+\.?\d*" value="{{ in_data.REOPT_INPUTS.get('longitude','-89.6501') }}"/>
                </div>
                <div class="chunk">
                    <label class="tooltip" for="QSTS_STEPS">Interconn. Time Steps (hours)<span class="classic">Defines the length of the interconnection analysis. Example â€“ if time steps are 15 minutes, 480 would define a five day analysis.</span></label>
                    <input type="text" name="QSTS_STEPS" value="{{in_data.QSTS_STEPS}}" />
                </div>
                <br>
                <div class="chunk">
                    <label class="tooltip" for="DESCRIPTION">Description<span class="classic">Include an optional description of the project. Max 140 characters.</span></label>
                    <textarea id="DESCRIPTION" name="DESCRIPTION" rows="1" cols="30">{{in_data.DESCRIPTION}}</textarea>
                    <p id="characterCount" style="display:inline">0 / 140</p>
                </div>
                <div>
                    <i class="fa fa-plus-square"></i>
                    <a href="javascript:void(0)" class="toggle show">Optional inputs</a>
                    <div style="display:none">
                        <div class="chunk">
                            <label class="tooltip" for="energyCost">Energy Cost ($/kWh)<span class="classic">Specify the energy cost. Format 0.XX</span></label>
                            <input type="text" name="energyCost" value="{{ in_data.REOPT_INPUTS.get('energyCost','0.12') }}" pattern="^\d+\.?\d*?$"/>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="wholesaleCost">Wholesale Cost ($/kWh)<span class="classic">Specify wholesale price for selling excess electricity back to the grid operator. Format 0.XX</span></label>
                            <input type="text" name="wholesaleCost" value="{{ in_data.REOPT_INPUTS.get('wholesaleCost','0.034') }}" pattern="^\d+\.?\d*?$"/>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="demandCost">Demand Cost ($/kW)<span class="classic">Specify the demand cost in $/kW. Format 0.XX</span></label>
                            <input type="text" name="demandCost" value="{{ in_data.REOPT_INPUTS.get('demandCost','20') }}" pattern="^\d+\.?\d*?$"/>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="solarCanCurtail">DG Can Curtail<span class="classic">Allows for excess distributed generation to be automatically curtailed.</span></label>
                            <select id="solarCanCurtail" name="solarCanCurtail">
                                <option {% if in_data.REOPT_INPUTS.solarCanCurtail == True %}selected{% endif %} value="true">Yes</option>
                                <option {% if in_data.REOPT_INPUTS.solarCanCurtail == False %}selected{% endif %} value="false">No</option>
                            </select>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="solarCanExport">DG Can Export<span class="classic">Allows for excess distributed generation to be sold back to the grid.</span></label>
                            <select id="solarCanExport" name="solarCanExport">
                                <option {% if in_data.REOPT_INPUTS.solarCanExport == True %}selected{% endif %} value="true">Yes</option>
                                <option {% if in_data.REOPT_INPUTS.solarCanExport == False %}selected{% endif %} value="false">No</option>
                            </select>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="urdbLabelSwitch">Use URDB Rate?<span class="classic">Utilizing a rate from the Utility Rate Database overrides Cost of Energy and Cost of Demand rates above. See https://openei.org/services/<br>doc/rest/util_rates/</span></label>
                            <select id="urdbLabelSwitch" name="urdbLabelSwitch">
                                <option {% if in_data.REOPT_INPUTS.urdbLabelSwitch == "on" %}selected{% endif %} value="on">Yes</option>
                                <option {% if 'urdbLabelSwitch' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.urdbLabelSwitch == "off" %}selected{% endif %} value="off">No</option>
                            </select>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="urdbLabel">URDB Label<span class="classic">Input the string found at the end of the URDB Rate URL, For example https://openei.org/apps/<br>IURDB/rate/view/<br> 5b75cfe95457a3454faf0aea <br> would yield "5b75cfe95457a3454faf0aea"</span></label>
                            <input type="text" name="urdbLabel" value="{{ in_data.REOPT_INPUTS.get('urdbLabel','5b75cfe95457a3454faf0aea') }}"/>
                        </div>
                    </div>
                </div>
                <h5>Load Profile</h5>
                <div class="chunk">
                    {% if in_data.get('LOAD_CSV') %}
                        <label class="tooltip" for="LOAD_CSV_NAME">Load Data (.csv)<span class="classic">Please upload a .csv file representing the hourly load shape. See https://github.com/dpinney/<br>microgridup/blob/main/docs<br>/input_formats.md for formatting details.</span></label>
                        <input type="text" name="LOAD_CSV_NAME" value="{{ in_data.get('LOAD_CSV') }}" class="file-input" readonly>
                        <button type="button" class="remove-btn">Remove File</button>
                    {% else %}
                        <div id='csvLoadParserInsert'></div>
                    {% endif %}
                </div>
				<div class="chunk">
					<label class="tooltip" for="analysisYears">Analysis Period (years)<span class="classic">Specify the length of financial analysis in years.</span></label>
					<input type="text" name="analysisYears" value="{{ in_data.REOPT_INPUTS.get('analysisYears','25') }}" step="1" min="2" max="75"/>
				</div>
                <div>
                    <i class="fa fa-plus-square"></i>
                    <a href="javascript:void(0)" class="toggle show">Optional inputs</a>
                    <div style="display:none">
						<div class="chunk">
							<label class="tooltip" for="year">Year<span class="classic">Specify the year to which the load shape values correspond.</span></label>
							<input type="text" name="year" value="{{ in_data.REOPT_INPUTS.get('year','2017') }}" pattern="^\d{4}$"/>
						</div>
                    </div>
                </div>
                <h5>Resilience</h5>
                <div class="chunk">
                    <label class="tooltip" for="FAULTED_LINE">Outage Location(s)<span class="classic">Node number in distribution map where typical outage would take place.</span></label>
                    <input type="text" name="FAULTED_LINE" value="{{in_data.FAULTED_LINE}}" />
                </div>
                <div class="chunk">
                    <label class="tooltip" for="outageDuration">Outage Duration (hours)<span class="classic">The added major outage is given this duration.</span></label>
                    <input type="text" name="outageDuration" value="{{ in_data.REOPT_INPUTS.get('outageDuration','48') }}" min="1" max="8760"/>
                </div>
				<div class="chunk">
                    {% if in_data.get('HISTORICAL_OUTAGES') %}
                        <label class="tooltip" for="HISTORICAL_OUTAGES">Historical Outage Data (.csv)<span class="classic">Please upload a .csv file representing historical outages. See https://github.com/dpinney/<br>microgridup/blob/main/docs<br>/input_formats.md for formatting details.</span></label>
                        <input type="text" name="HISTORICAL_OUTAGES" value="{{ in_data.get('HISTORICAL_OUTAGES') }}" class="file-input" readonly>
                        <button type="button" class="remove-btn">Remove File</button>
                    {% else %}
                        <label class="tooltip" for="HISTORICAL_OUTAGES">Historical Outage Data (.csv)<span class="classic">Please upload a .csv file representing historical outages. See https://github.com/dpinney/<br>microgridup/blob/main/docs<br>/input_formats.md for formatting details.</span></label>
                        <input type="file" name="HISTORICAL_OUTAGES" class="file-input">
                        <button type="button" class="remove-btn">Remove File</button>
                    {% endif %}
                </div>
                <div>
                    <i class="fa fa-plus-square"></i>
                    <a href="javascript:void(0)" class="toggle show">Optional inputs</a>
                    <div style="display:none;">
						<div class="chunk">
                            <label class="tooltip" for="DIESEL_SAFETY_FACTOR">Fossil Safety Margin (%)<span class="classic">TO DO: FILL TOOLTIP</span></label>
                            <input type="text" name="DIESEL_SAFETY_FACTOR" value="{{in_data.DIESEL_SAFETY_FACTOR}}" />
                        </div>
                    </div>
                </div>
                <h5>Financial</h5>
                <div class="chunk">
                    <label class="tooltip" for="value_of_lost_load">Value of Lost Load ($/kWh)<span class="classic">Specify the value of lost load during a power outage in $/kWh.</span></label>
                    <input type="text" name="value_of_lost_load" value="{{ in_data.REOPT_INPUTS.get('value_of_lost_load','1') }}" pattern="^\d+\.?\d*?$"/>
                </div>
                <div>
                    <i class="fa fa-plus-square"></i>
                    <a href="javascript:void(0)" class="toggle show">Optional inputs</a>
                    <div style="display:none">
                        <div class="chunk">
                            <label class="tooltip" for="omCostEscalator">O+M Escalation (% per year)<span class="classic">Please enter a number 0-1 for the Annual nominal O&M cost escalation rate. Format 0.XXX</span></label>
                            <input type="text" name="omCostEscalator" value="{{ in_data.REOPT_INPUTS.get('omCostEscalator','0.025') }}" step="0.001" min="0.0" max="1.0"/>
                        </div>
                        <div class="chunk">
                            <label class="tooltip" for="discountRate">Discount Rate (% per year)<span class="classic">Please enter a number 0-1 for the rate used to discount future cash flows in a net present value analysis. In single ownership model the offtaker is also the generation owner. Format 0.XXX</span></label>
                            <input type="text" name="discountRate" value="{{ in_data.REOPT_INPUTS.get('discountRate','0.083') }}" step="0.001" min="0.0" max="1.0"/>
                        </div>
                    </div>
                </div>
            </form>

            <h3>Step 2: Specify existing circuit</h3>
            <p>Please select your circuit creation method:</p>
            <input type="radio" id="upload" name="circuit" value="Upload" />
            <label for="upload">Upload circuit from file</label><br>
            <input type="radio" id="wizard" name="circuit" value="Creator" />
            <label for="wizard">Build circuit manually</label><br>

            <div id="circuitUpload" class="desc" style="margin-top:10px">
                <div class="chunk">
                    <form id="upload-file" method="post" enctype="multipart/form-data">
                        {% if in_data.get('BASE_DSS') %}
                            <fieldset>
                                <label for="BASE_DSS_NAME">Circuit Definition (.dss)</label>
                                <input id="circuitPostCreation" type="text" name="BASE_DSS_NAME" value="{{in_data.BASE_DSS}}" class="file-input" readonly />
                            </fieldset>
                            <fieldset>
                                <button id="upload-file-btn" type="button" hidden>Upload</button>
                                <button id="remove-ciruit-button" type="button" class="remove-btn">Remove File</button>
                            </fieldset>
                        {% else %}
                            <fieldset>
                                <label for="BASE_DSS_NAME">Circuit Definition (.dss)</label>
                                <input name="BASE_DSS_NAME" type="file" class="file-input">
                            </fieldset>
                            <fieldset>
                                <button id="upload-file-btn" type="button">Upload</button>
                                <button type="button" class="remove-btn">Remove File</button>
                            </fieldset>
                        {% endif %}
                    </form>
                </div>
            </div>
            <div id="circuitCreator" class="desc"></div>

            <div id="critLoads">
            </div>

        </div>

        <div id="partitionPreviewerContainer" class="step">
            <h3>Step 3: Partition circuit into microgrids</h3>
            <div id="stepThree" class="chunk">
                <label class="tooltip" for="MG_DEF_METHOD">Microgrid Definition Method<span class="classic">Select a method by which the circuit should be partitioned into microgrids.</span></label>
                <select id="partitionMethod" name="MG_DEF_METHOD" style="margin-right:6px" disabled>
                    <option value="" disabled selected>Select method</option>
                    <option value="manual" {% if in_data.MG_DEF_METHOD == 'manual' %}selected{% endif %}>Manual</option>
                    <option value="loadGrouping" {% if in_data.MG_DEF_METHOD == 'load_grouping' %}selected{% endif %}>Load Grouping</option>
                    <option value="lukes" {% if in_data.MG_DEF_METHOD == 'lukes' %}selected{% endif %}>Lukes</option>
                    <option value="branch" {% if in_data.MG_DEF_METHOD == 'branch' %}selected{% endif %}>Branch</option>
                    <option value="bottomUp" {% if in_data.MG_DEF_METHOD == 'bottom-up' %}selected{% endif %}>Bottom-Up</option>
                    <option value="criticalLoads" {% if in_data.MG_DEF_METHOD == 'critical_loads' %}selected{% endif %}>Critical Loads</option>
                </select></br>
                <form id="partitionManuallyForm" style="display: none;">
                    <label for="mgQuantity">How many microgrids?</label>
                    <input id="mgQuantity" type="text" autocomplete="off" placeholder="# of microgrids" />
                    <button id="makeDropdownsButton" type="button">Go</button><br>
                </form>
                <form id="minQuantMgsForm" style="display: none;">
                    <label for="mingQuantMgs">At least how many microgrids?</label>
                    <input id="minQuantMgs" type="text" autocomplete="off" placeholder="Min # of microgrids" />
                </form>
                <div id="dropDowns" class="chunk" style="display: none;">
                </div>
                <button id="previewPartitionsButton" type="button" disabled>Preview partitions</button>
                <div id="partitionsPreviewDiv">
                </div>
            </div>
        </div>

        <div id='techSelect' class='step'>
            <h3>Step 4: Select technologies to be used in microgrids</h3>
            <form id="techParamForm" enctype="multipart/form-data">
                <div class="chunk">
                    <label for="solar">Solar</label>
                    <input type="checkbox" name="solar" value="on" id="solar" {% if in_data.REOPT_INPUTS.solar == 'on' %}checked{% endif %}/>
                    <input type="hidden" name="solar" value="off">
                </div>
                <div class="chunk">
                    <label for="battery">Battery</label>
                    <input type="checkbox" name="battery" value="on" id="battery" {% if in_data.REOPT_INPUTS.battery == 'on' %}checked{% endif %}/>
                    <input type="hidden" name="battery" value="off">
                </div>
                <div class="chunk">
                    <label for="fossil">Fossil</label>
                    <input type="checkbox" name="fossil" value="on" id="fossil" {% if in_data.REOPT_INPUTS.fossil == 'on' %}checked{% endif %}/>
                    <input type="hidden" name="fossil" value="off">
                </div>
                <div class="chunk">
                    <label for="wind">Wind</label>
                    <input type="checkbox" name="wind" value="on" id="wind" {% if in_data.REOPT_INPUTS.wind == 'on' %}checked{% endif %}/>
                    <input type="hidden" name="wind" value="off">
                </div>

                <div id="solarDiv" style="display:none">
                    <h5>Solar</h5>
                    <div class="chunk">
                        <label class="tooltip" for="solarCost">Solar Cost ($/kW-DC)<span class="classic">Specify the cost in $/kW-DC.</span></label>
                        <input type="text" name="solarCost" value="{{ in_data.REOPT_INPUTS.get('solarCost','1600') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="solarMax">Solar Power Max (kW-DC)<span class="classic">Specify the maximum desired generation in kW-DC. Leave at default for full optimization on solar power.</span></label>
                        <input type="text" name="solarMax" value="{{ in_data.REOPT_INPUTS.get('solarMax','100000') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="solarMin">Solar Power Min (kW-DC)<span class="classic">Specify the minimum desired generation in kW-DC.</span></label>
                        <input type="text" name="solarMin" value="{{ in_data.REOPT_INPUTS.get('solarMin','0') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="solarMacrsOptionYears">Solar MACRS Years<span class="classic">MACRS schedule for financial analysis. Possible inputs are 0, 5 and 7 years. Set to zero to disable accelerated depreciation accounting for solar.</span></label>
                        <select id="solarMacrsOptionYears" name="solarMacrsOptionYears">
                            <option {% if in_data.REOPT_INPUTS.solarMacrsOptionYears == "0" %}selected{% endif %} value="0">0</option>
                            <option {% if 'solarMacrsOptionYears' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.solarMacrsOptionYears == "5" %}selected{% endif %} value="5">5</option>
                            <option {% if in_data.REOPT_INPUTS.solarMacrsOptionYears == "7" %}selected{% endif %} value="7">7</option>
                        </select>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="solarItcPercent">Solar ITC (% as decimal)<span class="classic">Please enter a number 0-1 for the solar investment tax credit. Format 0.XX</span></label>
                        <input type="text" name="solarItcPercent" value="{{ in_data.REOPT_INPUTS.get('solarItcPercent','0.26') }}" step="0.01" min="0.0" max="1.0"/>
                    </div>
                </div>
                <div id="batteryDiv" style="display:none">
                    <h5>Battery</h5>
                    <div class="chunk">
                        <label class="tooltip" for="batteryCapacityCost">Battery Capacity Cost ($/kWh-AC)<span class="classic">Specify the cost in $/kWh.</span></label>
                        <input type="text" name="batteryCapacityCost" value="{{ in_data.REOPT_INPUTS.get('batteryCapacityCost','420') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryCapacityMax">Battery Capacity Max (kWh-AC)<span class="classic">Specify the maximum desired battery capacity in kWh.</span></label>
                        <input type="text" name="batteryCapacityMax" value="{{ in_data.REOPT_INPUTS.get('batteryCapacityMax','1000000') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryCapacityMin">Battery Capacity Min (kWh-AC)<span class="classic">Specify the minimum desired battery capacity in kWh.</span></label>
                        <input type="text" name="batteryCapacityMin" value="{{ in_data.REOPT_INPUTS.get('batteryCapacityMin','0') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryPowerCost">Battery Power Cost ($/kW-AC)<span class="classic">Specify the cost in $/kW.</span></label>
                        <input type="text" name="batteryPowerCost" value="{{ in_data.REOPT_INPUTS.get('batteryPowerCost','840') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryPowerMax">Battery Power Max (kW-AC)<span class="classic">Specify the maximum desired battery power in kW.</span></label>
                        <input type="text" name="batteryPowerMax" value="{{ in_data.REOPT_INPUTS.get('batteryPowerMax','1000000') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryPowerMin">Battery Power Min (kW-AC)<span class="classic">Specify the minimum desired battery power in kW.</span></label>
                        <input type="text" name="batteryPowerMin" value="{{ in_data.REOPT_INPUTS.get('batteryPowerMin','0') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryMacrsOptionYears">Battery MACRS Years<span class="classic">MACRS schedule for financial analysis. Possible inputs are 0, 5 and 7 years. Set to zero to disable accelerated depreciation accounting for solar.</span></label>
                        <select id="batteryMacrsOptionYears" name="batteryMacrsOptionYears">
                            <option {% if in_data.REOPT_INPUTS.batteryMacrsOptionYears == "0" %}selected{% endif %} value="0">0</option>
                            <option {% if in_data.REOPT_INPUTS.batteryMacrsOptionYears == "5" %}selected{% endif %} value="5">5</option>
                            <option {% if 'batteryMacrsOptionYears' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.batteryMacrsOptionYears == "7" %}selected{% endif %} value="7">7</option>
                        </select>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryItcPercent">Battery ITC (% as decimal)<span class="classic">Please enter a number 0-1 for the battery investment tax credit. Format 0.XX</span></label>
                        <input type="text" name="batteryItcPercent" value="{{ in_data.REOPT_INPUTS.get('batteryItcPercent','0') }}" step="0.01" min="0.0" max="1.0"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryPowerCostReplace">Battery Replacement Power Cost ($/kW-AC)<span class="classic">Specify the cost of replacing the battery inverter at the specified year in $/kW.</span></label>
                        <input type="text" name="batteryPowerCostReplace" value="{{ in_data.REOPT_INPUTS.get('batteryPowerCostReplace','410') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryCapacityCostReplace">Battery Replacement Capacity Cost ($/kWh-AC)<span class="classic">Specify the cost of replacing the battery capacity at the specified year in $/kWh.</span></label>
                        <input type="text" name="batteryCapacityCostReplace" value="200" value="{{ in_data.REOPT_INPUTS.get('batteryCapacityCostReplace','200') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryPowerReplaceYear">Battery Power Replacement (years)<span class="classic">Specify a year in which the battery power will be replaced at the cost specified in Battery Replacement Power Cost. Input is an integer less than or equal to the project period in years.</span></label>
                        <input type="text" name="batteryPowerReplaceYear" value="{{ in_data.REOPT_INPUTS.get('batteryPowerReplaceYear','10') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="batteryCapacityReplaceYear">Battery Capacity Replacement (years)<span class="classic">Specify a year in which the battery cells will be replaced at the cost specified in Battery Replacement Capacity Cost. Input is an integer less than or equal to the project period in years.</span></label>
                        <input type="text" name="batteryCapacityReplaceYear" value="{{ in_data.REOPT_INPUTS.get('batteryCapacityReplaceYear','10') }}"/>
                    </div>
                </div>
                <div id=fossilDiv style="display:none">
                    <h5>Fossil</h5>
                    <div class="chunk">
                        <label class="tooltip" for="dieselGenCost">Genset Cost ($/kW)<span class="classic">Specify the cost in $/kWh.</span></label>
                        <input type="text" name="dieselGenCost" value="{{ in_data.REOPT_INPUTS.get('dieselGenCost','500') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselMax">Genset Max (kW)<span class="classic">Specify max fossil generation in kW. Only specify if needed, as the optimization runs best if left unedited.</span></label>
                        <input type="text" name="dieselMax" value="{{ in_data.REOPT_INPUTS.get('dieselMax','1000000') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselMin">Genset Min (kW)<span class="classic">Specify minimum fossil generation in kW. Only specify if needed, as the optimization runs best if left unedited.</span></label>
                        <input type="text" name="dieselMin" value="{{ in_data.REOPT_INPUTS.get('dieselMin','0') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="fuelAvailable">Fuel Available (Gal)<span class="classic">Specify the amount of fuel available for all new and pre-existing generators in gallons.</span></label>
                        <input type="text" name="fuelAvailable" value="{{ in_data.REOPT_INPUTS.get('fuelAvailable','50000') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="minGenLoading">Min Gen Loading (% as decimal)<span class="classic">Please enter a number 0-1 for the the minimum fraction of rated total kVA load that must be maintained by the generator. >/= 0.3 recommended for extended diesel operation. Set to 0 for highest likelihood of success in solving optimization. Format 0.XX</span></label>
                        <input type="text" name="minGenLoading" value="{{ in_data.REOPT_INPUTS.get('minGenLoading','0.3') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselFuelCostGal">Fuel Cost (diesel gal equiv)<span class="classic">Specify cost of fuel in $ per gallon. To convert $/MMBTU of Natural gas to gallons of diesel, divide $/MMBTU market rate by 4.85 to account for 50% lower efficiency of natural gas reciprocating engines and lower fuel density as compared to diesel. Format X.XX</span></label>
                        <input type="text" name="dieselFuelCostGal" value="{{ in_data.REOPT_INPUTS.get('dieselFuelCostGal','3') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselCO2Factor">Genset Emissions Factor (lb CO2/gal)<span class="classic">Specify fossil emissions factor in pounds of carbon dioxide per gallon. Default 22.4 is for diesel. Natural gas can be modeled using 24.1</span></label>
                        <input type="text" name="dieselCO2Factor" value="{{ in_data.REOPT_INPUTS.get('dieselCO2Factor','22.4') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselOMCostKw">Genset Annual O+M Cost ($/kW/year)<span class="classic">Specify annual operations and maintenance cost per kilowatt per year.</span></label>
                        <input type="text" name="dieselOMCostKw" value="{{ in_data.REOPT_INPUTS.get('dieselOMCostKw','10') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselOMCostKwh">Genset Hourly O+M Cost ($/kWh/year)<span class="classic">Specify annual operations and maintenance cost per kilowatt-hour per year. Format "X.XX"</span></label>
                        <input type="text" name="dieselOMCostKwh" value="{{ in_data.REOPT_INPUTS.get('dieselOMCostKwh','0') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselOnlyRunsDuringOutage">Genset only runs during outage?<span class="classic">"No" signifies that fossil generator is enabled to run at any point in the year.</span></label>
                        <select id="dieselOnlyRunsDuringOutage" name="dieselOnlyRunsDuringOutage">
                            <option {% if in_data.REOPT_INPUTS.dieselOnlyRunsDuringOutage == "true" %}selected{% endif %} value="true">Yes</option>
                            <option {% if 'dieselOnlyRunsDuringOutage' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.dieselOnlyRunsDuringOutage == "false" %}selected{% endif %} value="false">No</option>
                        </select>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="dieselMacrsOptionYears">Fossil MACRS Years<span class="classic">MACRS schedule for financial analysis. Possible inputs are 0, 5 and 7 years. Set to zero to disable accelerated depreciation accounting for solar.</span></label>
                        <select id="dieselMacrsOptionYears" name="dieselMacrsOptionYears">
                            <option {% if 'dieselMacrsOptionYears' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.dieselMacrsOptionYears == "0" %}selected{% endif %} value="0">0</option>
                            <option {% if in_data.REOPT_INPUTS.dieselMacrsOptionYears == "5" %}selected{% endif %} value="5">5</option>
                            <option {% if in_data.REOPT_INPUTS.dieselMacrsOptionYears == "7" %}selected{% endif %} value="7">7</option>
                        </select>
                    </div>
                </div>
                <div id="windDiv" style="display:none">
                    <h5>Wind</h5>
                    <div class="chunk">
                        <label class="tooltip" for="windCost">Wind Cost ($/kW)<span class="classic">Specify the cost in $/kW.</span></label>
                        <input type="text" name="windCost" value="{{ in_data.REOPT_INPUTS.get('windCost','4989') }}" pattern="^\d+\.?\d*?$"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="windMax">Wind Power Max (kW)<span class="classic">Specify the maximum desired generation in kW. Leave at default for full optimization on wind power.</span></label>
                        <input type="text" name="windMax" value="{{ in_data.REOPT_INPUTS.get('windMax','100000') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="windMin">Wind Power Min (kW)<span class="classic">Specify the minimum desired generation in kW.</span></label>
                        <input type="text" name="windMin" value="{{ in_data.REOPT_INPUTS.get('windMin','0') }}"/>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="windMacrsOptionYears">Wind MACRS Years<span class="classic">MACRS schedule for financial analysis. Possible inputs are 0, 5 and 7 years. Set to zero to disable accelerated depreciation accounting for solar.</span></label>
                        <select id="windMacrsOptionYears" name="windMacrsOptionYears">
                            <option {% if in_data.REOPT_INPUTS.windMacrsOptionYears == "0" %}selected{% endif %} value="0">0</option>
                            <option {% if 'windMacrsOptionYears' not in in_data.REOPT_INPUTS or in_data.REOPT_INPUTS.windMacrsOptionYears == "5" %}selected{% endif %} value="5">5</option>
                            <option {% if in_data.REOPT_INPUTS.windMacrsOptionYears == "7" %}selected{% endif %} value="7">7</option>
                        </select>
                    </div>
                    <div class="chunk">
                        <label class="tooltip" for="windItcPercent">Wind ITC (% as deimal)<span class="classic">Please enter a number 0-1 for the wind investment tax credit. Format 0.XX</span></label>
                        <input type="text" name="windItcPercent" value="{{ in_data.REOPT_INPUTS.get('windItcPercent','0.26') }}" step="0.01" min="0.0" max="1.0"/>
                    </div>
                </div>

                <br>
            </form>
            <button id="submitEverything" type="submit">Run model</button>
        </div>
        <div id="loading-background"></div>
        <div id="loading-indicator">
            <span>Loading...</span>
        </div>
    </main>
	<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
	<script>
	// Function to check if a .file-input (can be a file input or read-only text input) has a value and show/hide the associated Remove File button.
	function toggleRemoveButton(chunk, btnElement) {
		const fileInput = $(chunk).find('input.file-input');
		const removeBtn = $(chunk).find('button.remove-btn');
		const uploadedFile = $(fileInput).data('uploaded');
		const isNoneValue = uploadedFile === 'None';
		if ($(fileInput).val() || (uploadedFile && !isNoneValue) || (uploadedFile && $(fileInput).attr('type') === 'text')) {
			// Show the Remove File button if there is a file input value or uploadedFile is not 'None'. Also show the Remove File button if there is a non-empty uploadedFile value and the file input is a read-only text input.
			removeBtn.show();
		} else {
			removeBtn.hide();
			// Modify the behavior when the Remove File button is clicked for pre-Jinja'd file uploads (read-only text input).
			if ($(fileInput).attr('type') === 'text') {
				if ($(fileInput).attr('name') === 'LOAD_CSV_NAME') {
					var nameAttribute = 'LOAD_CSV';
					chunk[0].replaceChildren(window.csvLoadParser.modal.divElement);
					const removeBtn = $(chunk).find('button.remove-btn');
					removeBtn.hide();
				} else {
					const oldNameAttribute = $(fileInput).attr('name');
					var nameAttribute = oldNameAttribute;
					// Replace the read-only text input with a new file input.
					const newFileInput = $('<input type="file" class="file-input">').attr('name', nameAttribute);
					fileInput.replaceWith(newFileInput);
					// Set up the new file input for further functionality.
					newFileInput.on('change', function () {
						toggleRemoveButton(chunk, this);
					});
					toggleRemoveButton(chunk, newFileInput);
					// Show the upload button if user wants to upload new circuit.
					$('#upload-file-btn').show();
				}
			};
		}
	}

	// Function to limit description text.
	function limitTextareaCharacters() {
		var textarea = $('#DESCRIPTION')[0];
		var characterCount = $('#characterCount')[0];
		var text = textarea.value;
		var remainingCharacters = 140 - text.length;
		if (remainingCharacters < 0) {
			// Trim the text if it exceeds the character limit.
			textarea.value = text.substr(0, 140);
			remainingCharacters = 0;
		}
		characterCount.textContent = text.length + " / 140";
	}

	// Function to toggle technology checkboxes.
	function toggleDivVisibility(checkboxId, divId) {
		const checkbox = $(`#${checkboxId}`);
		const div = $(`#${divId}`);
		if (checkbox.is(':checked')) {
			div.slideDown(500);
		} else {
			div.slideUp(500);
		}
	}

	// Populate critical load selection div if editing an existing circuit.
	function getLoadsFromExistingFile(filePath, criticalLoads) {
		$.ajax({
			url: '/getLoadsFromExistingFile',
			method: 'POST',
			data: { path: filePath },
			success: function(response) {
				window.circuitIsSpecified = true;
				const loads = response.loads;
				$('#critLoads').empty();
				$('#critLoads').append('<p>Please select all critical loads:</p>')
				$('#dropDowns').empty();
				$('#dropDowns').hide();
				jQuery('<form>', {
					id: 'criticalLoadsSelect',
					class: 'chunk'
				}).appendTo('#critLoads');
				for (let i=0; i<loads.length; i++) {
					var checkbox = $('<input>').attr('type', 'checkbox');
					if (criticalLoads.includes(loads[i])) {
						checkbox.prop('checked', true);
					}
					var label = $('<label>').append(checkbox).append(loads[i]);
					$('#criticalLoadsSelect').append(label)
					$('#dropDowns').append('<label><select></select> '+loads[i]+'</label><br>')
				}
				if (loads.length === 0) {
					$('#criticalLoadsSelect').append('<p>No loads to select from.</p>')
				}
				// Make directory uneditable. 
				{% if iframe_mode %}
				disableInputs();
				{% endif %}
				$('input[name="MODEL_DIR"]').prop("readonly", true);
			},
			error: function(xhr, status, error) {
				// Handle errors, if any.
				console.error(error);
			}
		});
	}

	// Function to show previously selected partitions on edit flow.
	function showOldPartitions(filename, MG_MINES) {
		$('#stepThree').hide();
		var oldPartitionsDiv = $('<div>').attr('id','oldPartitionDiv').addClass('chunk');
		// Grab a NetworkX diagram of current partition layout.
		var data = {
			filename: filename,
			MG_MINES: MG_MINES
		};
		$.ajax({
			type: 'POST',
			url: '/previewOldPartitions',
			data: JSON.stringify(data),
			contentType: 'application/json',
			success: function(data, status) {
				var img = $('<img id="oldPartitionPreview">');
				img.attr('src', 'data:image/gif;base64,' + data);
				oldPartitionsDiv.prepend('<br>')
				oldPartitionsDiv.prepend(img); 
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log(textStatus + ' : ' + errorThrown);
			}
		})
		$('#partitionPreviewerContainer').append(oldPartitionsDiv);
		var partitionButton = $('<button>').text('Partition circuit differently');
		oldPartitionsDiv.append(partitionButton);
		partitionButton.on('click', function() {
			$('#stepThree').show();
			oldPartitionsDiv.hide();
			$('#previewPartitionsButton').prop('disabled', false);
			$('#partitionMethod').prop('disabled', false);
		});
	}

	function attachDropdownsEventHandler() {
		// Manual partitioning dynamic dropdown creation. 
		$('#makeDropdownsButton').on('click', function() {
			if (window.circuitIsSpecified === false) {
				alert('Please complete step 2.')
				return
			}
			if ($('#mgQuantity').val() === "") {
				alert('Please input a number.')
				return
			}
			// Manual grouping GUI includes inputs for gen_bus and switch.
			var numMgs = $('#mgQuantity').val();
			if ($('#partitionMethod').val() == 'manual') {
				// Clear existing #switchGenbus if it exists already. 
				$('#switchGenbus').remove();
				$('#dropDowns').prepend('<div id="switchGenbus"></div>')
				for (let i = 0; i < numMgs; i++) {
					var count = i + 1;
					$('#switchGenbus').append('<label for="mg' + count + 'Genbus">Mg' + count + ' Gen Bus: </label>');
					$('#switchGenbus').append('<input id="mg' + count + 'Genbus" type="text"></input>');
					$('#switchGenbus').append('<label for="mg' + count + 'Switch"> Mg' + count + ' Switch: </label>');
					$('#switchGenbus').append('<input id="mg' + count + 'Switch" type="text"></input>');
					$('#switchGenbus').append('<br>');
				}
			}
			$('#dropDowns label select').each(function() {
				$(this).empty();
				$(this).append('<option value="">None</option>')
				for (let i = 0; i < numMgs; i++) {
					var count = i + 1;
					$(this).append('<option value="Mg' + count + '">Mg' + count + '</option>');
				}
			});
			$('#dropDowns').show();
		})
		// Also call above function if user presses enter.
		$('#mgQuantity').keypress(function(e){
			if (e.which === 13) {
				e.preventDefault();
				$('#makeDropdownsButton').click();
			}
		});
	}

	function attachPartitioningEventHandler() {
		// Hide/show manual partitioning div. 
		$('#partitionMethod').change(function() {
			$('#minQuantMgs').val('');
			if ($(this).val() == 'manual' || $(this).val() == 'loadGrouping') {
				$('#partitionManuallyForm').show();
				$('#makeDropdownsButton').show();
				$('#previewPartitionsButton').hide();
				$('#minQuantMgsForm').hide();
				$('#partitionsPreviewDiv').empty();
			}
			else { 
				$('#partitionManuallyForm').hide();
				$('#minQuantMgsForm').hide();
				$('#dropDowns').hide();
				$('#previewPartitionsButton').show();
			}
			if ($(this).val() == 'loadGrouping') {
				$('#switchGenbus').remove();
			}
			if ($(this).val() == 'bottomUp' || $(this).val() == 'criticalLoads') {
				$('#minQuantMgsForm').show();
				$('#makeDropdownsButton').hide();
			}
		})
	}

	// Grab partitioning preview.
	function attachPartitionButtonEventHandler() {
		$('#previewPartitionsButton').click(function() {
			if (window.circuitIsSpecified === false) {
				alert('Please complete step 2.')
				return
			}
			// Get critical loads, if any.
			critLoads = new Array();
			$('#criticalLoadsSelect label').each(function() {
				if ($(this).find('input')[0].checked) {
					var element = $(this).text();
					critLoads.push(element);
				}
			});
			// Get partitioning method.
			var method = $( "#partitionMethod option:selected" ).val();
			if (method === "") {
				alert('Please ensure you have chosen a partition method.');
				return
			}
			// Get mgQuantity, if applicable. 
			var mgQuantity = $('#minQuantMgs').val() ? $('#minQuantMgs').val() : 0;
			$.ajax({
				url: 'previewPartitions',
				type: 'POST',
				data: {
					critLoads : JSON.stringify(critLoads),
					fileName : JSON.stringify(window.filename),
					method : JSON.stringify(method),
					mgQuantity : JSON.stringify(mgQuantity)
				},
				success: function(data, status) {
					if (data === 'Invalid partitioning method') {
						alert('Selected partitioning method produced invalid results. Please choose a different partitioning method.');
					} else {
						// Create image.
						var img = $('<img id="previewImage">');
						img.attr('src', 'data:image/gif;base64,' + data);
						$('#partitionsPreviewDiv').empty();
						img.appendTo('#partitionsPreviewDiv'); 
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(textStatus + ' : ' + errorThrown)
				}
			});
		});
		// Also call above function if user presses enter.
		$('#minQuantMgs').keypress(function(e) {
			if (e.which === 13) {
				e.preventDefault();
				$('#previewPartitionsButton').click();
			}
		});
	}

	function disableInputs() {
		[...document.getElementsByTagName('input')].forEach(input => {
			input.disabled = true;
		});
		[...document.getElementsByTagName('button')].forEach(button => {
			button.disabled = true;
		});
		[...document.getElementsByTagName('select')].forEach(select => {
			select.disabled = true;
		});
		[...document.getElementsByTagName('textarea')].forEach(textArea => {
			textArea.disabled = true;
		});
	}

	function validateForm(form) {
		var inputs = form.querySelectorAll("input");
		var valid = true;
		for (var i = 0; i < inputs.length; i++) {
			var input = inputs[i];
			if (!input.checkValidity()) {
			valid = false;
			input.style.border = "1px solid red";
			} else {
			input.style.border = "";
			}
		}
		return valid;
	}

	function highlightIncorrectFields(form) {
		var inputs = form.querySelectorAll("input");
		for (var i = 0; i < inputs.length; i++) {
			var input = inputs[i];
			if (!input.checkValidity()) {
				input.style.border = "1px solid red";
			}
		}
	}

	// Submit everything. 
	function submitEverything() {
		// Do not proceed if no circuit is specified.
		if (window.filename === '') {
			alert('Please specify a circuit.')
			return 
		}
		// Do not proceed if no loads are specified.
		if ((!$('[name="LOAD_CSV"]').val()) && (!$('[name="LOAD_CSV_NAME"]').val())) {
			alert('Please specify load data.')
			return
		}
		// Do not proceed if no partition method is specified.
		if (($( "#partitionMethod option:selected" ).val() === '') & ($('#oldPartitionDiv').length == 0)) {
			alert('Please specify a partitioning method.')
			return 
		}
		var form1 = new FormData(document.getElementById("modelInfoForm"));
		var form2 = new FormData(document.getElementById("techParamForm"));
		for (var pair of form2.entries()) {
				form1.append(pair[0], pair[1]);
			}
		// Specificy circuit location.
		const dss_path = $('#circuitPostCreation').val();
		if (dss_path == undefined) {
			form1.append('DSS_PATH','Direct to uploads folder.');
		} else {
			form1.append('DSS_PATH',dss_path);
		}
		// Specify outages path if reused.
		const outages_path = document.getElementsByName('HISTORICAL_OUTAGES')[0].value;
		if (outages_path == '' || outages_path.includes('fakepath')) {
			form1.append('OUTAGES_PATH','Check files');
		} else {
			form1.append('OUTAGES_PATH',outages_path);
		}
		// Append CRITICAL_LOADS.
		critLoads = new Array();
		$('#criticalLoadsSelect label').each(function() {
			if ($(this).find('input')[0].checked) {
				var element = $(this).text();
				critLoads.push(element);
			}
		});
		form1.append('CRITICAL_LOADS',JSON.stringify(critLoads));
		// Append MG_DEF_METHOD. 
		var method = $( "#partitionMethod option:selected" ).val();
		form1.append('MG_DEF_METHOD',method);

		// Do not proceed if manual is selected and no partitions are created.
		if ((method === 'manual' && !$('#dropDowns').is(':visible')) || (method === 'loadGrouping' && !$('#dropDowns').is(':visible'))) {
			alert('Please enter a number of microgrids and press Go.')
			return
		}
		// If manual or loadGrouping is selected, append a 'MICROGRIDS' value.
		var MICROGRIDS = {}
		if ((method == 'manual') || (method == 'loadGrouping')) {
			$('#dropDowns label').each( function() {
				// Skip the Gen Buses and Switches.
				if (this.hasAttribute('for')) {
					return true
				}
				// console.log(this);
				var load = $(this).text().split(' ')[1]
				var mg = $(this).find(':selected').text()
				if (method === 'loadGrouping') {
					MICROGRIDS[mg] ??= [];
					MICROGRIDS[mg].push(load);
				}
				else if (method === 'manual') {
					MICROGRIDS.pairings ??= {};
					MICROGRIDS.pairings[mg] ??= [];
					MICROGRIDS['pairings'][mg].push(load); 
				}
			} )
			// Do not proceed if no loads are in microgrids.
			if ('pairings' in MICROGRIDS) {
				const pairings = MICROGRIDS.pairings;
				if (typeof pairings === 'object' && Object.keys(pairings).length === 1 && 'None' in pairings) {
					alert('At least one load should be placed in a microgrid. Please return to step 3.')
					return
				}
			} else {
				const keys = Object.keys(MICROGRIDS);
				if (keys.length === 1 && keys[0] === 'None') {
					alert('At least one load should be placed in a microgrid. Please return to step 3.')
					return
				}
			}
			// If manual is selected, append switch and gen_bus values.
			var counter = 0;
			$('#switchGenbus input').each( function() {
				counter = counter + 0.5;
				var id = $(this).attr('id');
				var val = $(this).val();
				var mg = 'Mg' + Math.round(counter);
				if (id.includes('Genbus')) {
					MICROGRIDS.gen_bus ??= {};
					MICROGRIDS.gen_bus[mg] = val;
				} 
				else {
					MICROGRIDS.switch ??= {};
					MICROGRIDS.switch[mg] = [String(val)];
				}
			})
		} else if (($('#circuitPostCreation').length) && (method == '')) {
			var MICROGRIDS = JSON.parse('{{ in_data.MICROGRIDS | tojson | safe }}');
		}
		form1.append('MICROGRIDS',JSON.stringify(MICROGRIDS));
		// Append mgQuantity. 
		var mgQuantity = $('#minQuantMgs').val() ? $('#minQuantMgs').val() : 0;
		form1.append('mgQuantity',JSON.stringify(mgQuantity));

		// Show loading indicator.
		$('#loading-background').show();
		$("#loading-indicator").show();

		const model_dir = $('input[name="MODEL_DIR"]').val();
		$.ajax({
			url: '/run',
			type: 'POST',
			data: form1,
			processData: false,
			contentType: false,
			success: function(data) {
				setTimeout(function () {
					window.location.href = `/load/${model_dir}`;
				}, 5000); // Delay relocation so files are created first.
			},
			error: function(jqXHR, textStatus, errorThrown) {
				// Hide loading indicator if server fails.
				$('#loading-background').hide();
				$("#loading-indicator").hide();
				console.log(textStatus + ' : ' + errorThrown)
			}
		})
	}

	window.circuitIsSpecified = false;
	window.filename = '';

	$(document).ready(function() {
		// Clone partitioning div for resetting.
		var stepThreeClone = $("#stepThree").clone();
		// Attach event handlers for partitioning, dropdown creation, and partition button behavior.
		attachPartitioningEventHandler();
		attachDropdownsEventHandler();
		attachPartitionButtonEventHandler();

		$('.chunk').each(function () {
			toggleRemoveButton(this);
		});

		// Add click event listeners to the Remove File buttons.
		$(document).on('click', 'button.remove-btn', function () {
			const chunk = $(this).closest('.chunk');
			const fileInput = chunk.find('input.file-input');
			// Clear the file input value and hide the Remove File button.
			fileInput.val('');
			$(this).hide();
			toggleRemoveButton(chunk, this);

			// Special behavior if user removes circuit.
			if ($(this).attr('id') == 'remove-ciruit-button') {
				$('#wizard').prop('disabled', false);
				// Clear critical loads select and reset partitioning.
				$('#critLoads').empty();
				$('#stepThree').show();
				$('#oldPartitionDiv').hide();
				$('#previewPartitionsButton').prop('disabled', false);
				$('#partitionMethod').prop('disabled', false);
				// Reset previous partitioning.
				$("#stepThree").replaceWith(stepThreeClone.clone());
				// Reattach partitioning, dropdown creation, and partition button event handler. 
				attachPartitioningEventHandler();
				attachDropdownsEventHandler();
				attachPartitionButtonEventHandler();
			}
		});

		// Function to check if a .file-input has a value and show/hide the associated Remove button after a new file is selected.
		$(document).on('change', 'input.file-input', function () {
			const chunk = $(this).closest('.chunk');
			toggleRemoveButton(chunk);
		});

		// Limit characters in description textarea.
		$("#DESCRIPTION").on("input", limitTextareaCharacters);
		
		// Enable technology toggling.
		toggleDivVisibility('solar', 'solarDiv');
		toggleDivVisibility('battery', 'batteryDiv');
		toggleDivVisibility('fossil', 'fossilDiv');
		toggleDivVisibility('wind', 'windDiv');
		$('#solar').change(function() {
			toggleDivVisibility('solar', 'solarDiv');
		});
		$('#battery').change(function() {
			toggleDivVisibility('battery', 'batteryDiv');
		});
		$('#fossil').change(function() {
			toggleDivVisibility('fossil', 'fossilDiv');
		});
		$('#wind').change(function() {
			toggleDivVisibility('wind', 'windDiv');
		});

		// Enable circuit definition method choice.
		$("div.desc").hide();
		[...document.querySelectorAll('input[type="radio"][name="circuit"]')].forEach(input => input.checked = false);
		$("input[name$='circuit']").click(function() {
			var test = $(this).val();
			$("div.desc").hide();
			$("#circuit" + test).show();
		});
		
		// If user clicked edit, show used circuit.
		if ($('#circuitPostCreation').length) {
			$('#circuitUpload').show();
			$('#upload').prop('checked', true);
			$('#wizard').attr('disabled', true);
			window.circuitIsSpecified = true;
			window.filename = $('#circuitPostCreation').val();
			// Get allDataInputs.json params from Jinja as variables in the script.
			var in_data = JSON.parse('{{ in_data | tojson | safe }}');
			var criticalLoads = in_data['CRITICAL_LOADS'];
			var MG_MINES = in_data['MICROGRIDS'];
			// Also populate critical load selection div.
			getLoadsFromExistingFile(window.filename, criticalLoads);
			// Also populate partitioning preview div from original run.
			showOldPartitions(window.filename, MG_MINES)
		}

		// Upload DSS circuit. Get loads.
		$('#upload-file-btn').click(function() {
			// Do not proceed if model has no name.
			if ($('input[name="MODEL_DIR"]').val() === '') {
				alert('Please specify a model name.')
				return 
			}
			var form_data = new FormData($('#upload-file')[0]);
			var model_dir = $('input[name="MODEL_DIR"]').val()
			form_data.append('MODEL_DIR',model_dir)
			$.ajax({
				type: 'POST',
				url: '/uploadDss',
				data: form_data,
				contentType: false,
				cache: false,
				processData: false,
				success: function(data) {
					// Enable partition selector.
					$('#previewPartitionsButton').prop('disabled', false);
					$('#partitionMethod').prop('disabled', false);
					window.circuitIsSpecified = true;
					const loads = data.loads;
					$('#critLoads').empty();
					$('#critLoads').append('<p>Please select all critical loads:</p>')
					// Clear previous content and add loads to dropdowns (shown if user chooses manual partitioning.)
					$('#dropDowns').empty();
					$('#dropDowns').hide();
					jQuery('<form>', {
						id: 'criticalLoadsSelect',
						class: 'chunk'
					}).appendTo('#critLoads');
					for (let i=0; i<loads.length; i++) {
						$('#criticalLoadsSelect').append('<label><input type="checkbox">'+loads[i]+'</label>')
						$('#dropDowns').append('<label><select></select> '+loads[i]+'</label><br>')
					}
					if (loads.length === 0) {
						$('#criticalLoadsSelect').append('<p>No loads to select from.</p>')
					}
					// Set filename.
					window.filename = data.filename;
					// Make directory uneditable. 
					$('input[name="MODEL_DIR"]').prop("readonly", true);
				}
			});
		});

		// Show/hide optional inputs.
		$('.toggle').click(function() {
			if ( $(this).hasClass('show') ) {
				//replace the text
				$(this).text('Show fewer inputs');
				//replace the icon
				$(this).prev('i').removeClass('fa-plus-square').addClass('fa-minus-square');
				$(this).removeClass('show').addClass('hide');
			} else {
				//replace the text
				$(this).text('Optional inputs');
				//replace the icon
				$(this).prev('i').removeClass('fa-minus-square').addClass('fa-plus-square');
				$(this).removeClass('hide').addClass('show');                
			}
			$(this).next('div').slideToggle('500');
		});

		// Validate forms.
		$('#submitEverything').click(function() {
			var form1 = document.getElementById("modelInfoForm");
			var form2 = document.getElementById("techParamForm");

			// Validate form inputs
			var form1Valid = validateForm(form1);
			var form2Valid = validateForm(form2);

			if (form1Valid && form2Valid) {
				// Submit the forms
				submitEverything();
			} else {
				// Show alert and highlight incorrect fields
				if (!form1Valid) {
				highlightIncorrectFields(form1);
				}
				if (!form2Valid) {
				highlightIncorrectFields(form2);
				}
				alert('Please correct the input fields higlighted with red borders.');
			}
		});

        {% if iframe_mode %}
        disableInputs();
        {% endif %}
	});
	</script>
	<script type='module'>
	import { CircuitElement, CircuitModel, CircuitController, CircuitTableView, CircuitUserControlsView, CsvLoadParser } from '/data/static/circuitBuilder/modals/circuitBuilder.js';
	const circuitElements = [
		{
			name: 'substation_1',
			namespace: 'element',
			type: 'substation',
		},
		{
			name: 'feeder_1',
			namespace: 'element',
			type: 'feeder',
			parent: 'element.substation_1',
		},
		{
			name: 'solar_1',
			namespace: 'element',
			type: 'solar',
			parent: 'element.feeder_1',
			kw: 440
		},
		{
			name: 'wind_1',
			namespace: 'element',
			type: 'wind',
			parent: 'element.feeder_1',
			kw: 200
		},
		{
			name: 'fossil_1',
			namespace: 'element',
			type: 'fossil',
			parent: 'element.feeder_1',
			kw: 265
		},
		{
			name: 'battery_1',
			namespace: 'element',
			type: 'battery',
			parent: 'element.feeder_1',
			kwh: 307,
			kw: 79
		},
	].map(element => new CircuitElement(element));
	const model = new CircuitModel();
	circuitElements.forEach(e => model.addElement(e));
	const controller = new CircuitController(model);
	const table = new CircuitTableView(controller);
	model.addObserver(table);
	const csvLoadParser = new CsvLoadParser();
	const controls = new CircuitUserControlsView(controller, csvLoadParser);
	model.addObserver(controls);
	csvLoadParser.addObserver(controls);
	circuitElements.forEach(e => {
		model.addObserver(table, e.fullName);
		model.addObserver(controls, e.fullName);
	});
	document.getElementById('circuitCreator').append(table.modal.divElement);
	document.getElementById('circuitCreator').append(controls.modal.divElement);
	const csvLoadParserInsert = document.getElementById('csvLoadParserInsert');
	if (csvLoadParserInsert !== null) {
		csvLoadParserInsert.replaceWith(csvLoadParser.modal.divElement);
	} else {
		window.csvLoadParser = csvLoadParser;
	}
	</script>
</body>
</html>